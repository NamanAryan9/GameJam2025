import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls';

// Scene Setup
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// Lighting
const light = new THREE.AmbientLight(0xffffff, 1);
scene.add(light);

// Dreamy Background Animation
let hue = 0;
function updateBackground() {
  hue += 0.5;
  scene.background = new THREE.Color(`hsl(${hue % 360}, 100%, 50%)`);
}

// Button Object
const buttonGeometry = new THREE.CircleGeometry(1, 32);
const buttonMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
const button = new THREE.Mesh(buttonGeometry, buttonMaterial);
button.position.set(0, 0, 0);
scene.add(button);

// Portal Setup
const portalGeometry = new THREE.TorusGeometry(2, 0.5, 16, 100);
const portalMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
const portal = new THREE.Mesh(portalGeometry, portalMaterial);
portal.position.set(5, 0, 0);
scene.add(portal);

// Leaderboard (Fake Scores)
const leaderboard = [
  { name: "Player1", score: 1500 },
  { name: "Player2", score: 1200 },
  { name: "Player3", score: 900 }
];
function updateLeaderboard(playerName, score) {
  leaderboard.push({ name: playerName, score });
  leaderboard.sort((a, b) => b.score - a.score);
  console.log("Updated Leaderboard:", leaderboard);
}

// Difficulty Variables
let buttonSize = 1;
let buttonSpeed = 0.02;

// Camera Position
camera.position.z = 5;

// Controls
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// Animation Loop
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  updateBackground();

  // Button Movement
  button.position.x += (Math.random() - 0.5) * buttonSpeed;
  button.position.y += (Math.random() - 0.5) * buttonSpeed;
  renderer.render(scene, camera);
}
animate();

// Click Event
let score = 0;
window.addEventListener('click', (event) => {
  const mouse = new THREE.Vector2(
    (event.clientX / window.innerWidth) * 2 - 1,
    -(event.clientY / window.innerHeight) * 2 + 1
  );
  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, camera);

  const intersects = raycaster.intersectObjects([button, portal]);
  if (intersects.length > 0) {
    const clickedObject = intersects[0].object;
    if (clickedObject === button) {
      score += 10;
      console.log(`Score: ${score}`);
      buttonSize -= 0.05;
      button.scale.set(buttonSize, buttonSize, 1);
      if (buttonSize <= 0.2) buttonSize = 1;
    } else if (clickedObject === portal) {
      console.log('Portal entered! Redirecting...');
      window.location.href = 'http://portal.pieter.com?username=player1&ref=mygame.com';
    }
  }
});

// Handle Window Resize
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
